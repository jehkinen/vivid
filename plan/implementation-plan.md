---
name: Vivid Admin Layout Implementation
overview: Создание layout с боковой панелью в стиле Ghost для проекта Vivid, включая страницы Posts с фильтрами и поиском, страницу Tags с таблицей, редактирование тегов и публичные страницы тегов.
todos: []
---

# План реализации Admin Layout для Vivid

## Обзор

Создание полноценного admin-интерфейса с боковой панелью в стиле Ghost, включая управление постами и тегами.

## Структура изменений

### 1. Обновление схемы базы данных

- **Файл:** `prisma/schema.prisma`
- Переименовать схему с `memoria_react` на `vivid_react`:
  - В `datasource db`: изменить `schemas = ["memoria_react"]` на `schemas = ["vivid_react"]`
  - Во всех моделях (Post, Tag, PostTag, Author, PostAuthor): изменить `@@schema("memoria_react")` на `@@schema("vivid_react")`
- Добавить поле `color` (String, nullable) в модель `Tag` для хранения цвета тега
- **Структура ID и UUID (как в Ghost):**
  - `id` (varchar 24): короткий первичный ключ (cuid), используется в URL и внутренних ссылках
  - `uuid` (varchar 36): стандартный UUID v4, используется для интеграций, проиндексирован
  - Оба поля остаются в модели Post (как в текущей схеме)
- **Хранение контента:**
  - Сохранять `lexical` (основной формат редактора)
  - Сохранять `plaintext` (для поиска и других целей)
  - Сохранять `html` (для рендеринга)
  - При сохранении поста генерировать plaintext из lexical контента
- Выполнить миграцию базы данных для переименования схемы (или создать новую схему и перенести данные)

### 2. Создание компонентов UI

- **Файлы:** `components/ui/sidebar.tsx`, `components/ui/table.tsx`, `components/ui/dialog.tsx`, `components/ui/popover.tsx`, `components/ui/command.tsx`, `components/ui/badge.tsx`, `components/ui/toast.tsx`, `components/ui/toaster.tsx`, `components/ui/use-toast.ts`
- Добавить компоненты shadcn/ui: Sidebar, Table, Dialog для модальных окон
- Для мультиселекта тегов: использовать Popover + Command из shadcn/ui или создать кастомный MultiSelect компонент
- Badge компонент для отображения выбранных тегов как чипсы
- Toast компонент для отображения уведомлений об успехе/ошибках
- Команды: `npx shadcn@latest add sidebar`, `npx shadcn@latest add table`, `npx shadcn@latest add dialog`, `npx shadcn@latest add popover`, `npx shadcn@latest add command`, `npx shadcn@latest add badge`, `npx shadcn@latest add toast`

### 3. Создание Layout с боковой панелью

- **Файл:** `components/layout/AdminLayout.tsx`
- Компонент с боковой панелью слева и основным контентом справа
- Боковая панель содержит:
- Логотип/название "Vivid"
- Навигационные ссылки: Posts, Tags
- Иконки из lucide-react (FileText, Tag)
- Использовать компонент Sidebar из shadcn/ui
- Добавить иконку поиска в header (или использовать горячую клавишу Cmd/Ctrl+K)

### 4. Обновление корневого layout

- **Файл:** `app/layout.tsx`
- Обернуть все страницы в AdminLayout (кроме публичных маршрутов)

### 5. Страница Posts (список постов)

- **Файл:** `app/vivid/posts/page.tsx`
- Заголовок "Posts" с кнопкой "New post"
- Панель фильтров:
- Фильтр по тегам (мультиселект с возможностью выбора нескольких тегов):
- Комбобокс или MultiSelect компонент (на основе Popover + Command из shadcn/ui)
- Отображение выбранных тегов как чипсы (Badge компонент) с возможностью удаления (иконка X)
- Поиск по тегам внутри выпадающего списка
- Отображение цвета тега рядом с названием в списке
- Фильтрация постов, которые имеют хотя бы один из выбранных тегов (OR логика)
- При отсутствии выбранных тегов - показывать все посты
- Сортировка: "Newest first" / "Oldest First" / "Recently Updated" (Select)
- Таблица/список постов:
- Заголовок поста
- Статус (Draft/Published/Scheduled)
- Дата обновления/публикации
- Теги (чипсы)
- Иконка редактирования (ведет на `/vivid/posts/[id]`)

### 6. Обновление API для Posts

- **Файл:** `app/api/posts/route.ts`
- Расширить GET endpoint:
- Параметр `search` для поиска по title/plaintext (использовать plaintext для полнотекстового поиска)
- Параметр `tagIds` (массив tag IDs для фильтрации):
- Принимать как query параметр (например: `?tagIds=id1&tagIds=id2`)
- Или как JSON в query string
- Фильтровать посты, которые имеют хотя бы один из указанных тегов (OR логика)
- Параметр `sort` (newest, oldest, recently-updated)
- Возвращать посты с включенными тегами и авторами
- Все ошибки возвращать с понятными сообщениями для отображения в toast

### 7. Страница Tags (список тегов)

- **Файл:** `app/vivid/tags/page.tsx`
- Заголовок "Tags" с кнопкой "New tag"
- Таблица тегов:
- Колонка "Tag" (name + цветной индикатор)
- Колонка "Slug"
- Колонка "No. of Posts" (количество связанных постов)
- Колонка "Actions" с иконкой редактирования (ведет на `/vivid/tags/[slug]`)

### 8. API для Tags

- **Файл:** `app/api/tags/route.ts`
- GET: получить все теги с количеством постов
- POST: создать новый тег
- PUT: обновить тег
- DELETE: удалить тег (с проверкой связанных постов)
- Все ошибки возвращать с понятными сообщениями для отображения в toast

### 9. Страница редактирования тега

- **Файл:** `app/vivid/tags/[slug]/page.tsx`
- Форма редактирования:
- Поле Name (Input)
- Поле Color (ColorPicker или Input type="color")
- Поле Slug (Input, можно автогенерировать из name)
- Кнопки: "Save", "Delete" (с подтверждением через Dialog)
- Загрузка данных тега по slug из API

### 10. Обновление страницы редактирования поста

- **Файл:** `app/posts/[id]/page.tsx` → `app/vivid/posts/[id]/page.tsx`
- Переместить в `/vivid/posts/[id]`
- Обернуть в AdminLayout
- Добавить возможность выбора тегов при редактировании поста:
- Комбобокс/мультиселект для выбора тегов
- Отправлять массив `tagIds` в API при сохранении
- При сохранении генерировать `plaintext` из `lexical` контента для поиска

### 11. Публичная страница тега

- **Файл:** `app/tag/[slug]/page.tsx`
- Отображение всех опубликованных постов с данным тегом
- Заголовок с названием тега и цветом
- Список постов (заголовок, дата, краткое описание)
- Без sidebar (публичная страница)

### 12. Глобальный поиск (Command Palette)

- **Файл:** `components/search/GlobalSearch.tsx`
- Компонент поиска, появляющийся поверх всего контента с затемненным фоном
- Использовать Dialog из shadcn/ui с кастомным backdrop:
  - Затемненный фон (backdrop) с opacity ~0.6 и темным цветом
  - z-index высокий для отображения поверх всего
  - Клик по backdrop закрывает поиск
- Функциональность:
  - Открытие через горячую клавишу Cmd/Ctrl+K
  - Input для ввода поискового запроса
  - Результаты поиска в реальном времени:
    - Секция "POSTS" с результатами постов
    - Секция "TAGS" с результатами тегов (опционально)
  - Навигация по результатам клавиатурой (стрелки, Enter)
  - Выделение найденного текста
  - При клике на результат - переход на соответствующую страницу
- Интеграция в AdminLayout:
  - Обработчик горячей клавиши Cmd/Ctrl+K
  - Состояние открытия/закрытия поиска
  - Компонент доступен на всех admin страницах

### 13. API для глобального поиска

- **Файл:** `app/api/search/route.ts`
- GET endpoint для поиска:
  - Параметр `q` (query string) для поискового запроса
  - Поиск по постам: использовать `plaintext` для полнотекстового поиска (более эффективно, чем парсинг lexical)
  - Поиск по title и plaintext
  - Поиск по тегам (name, slug) - опционально
  - Возвращать результаты в формате:
    ```json
    {
      "posts": [...],
      "tags": [...]
    }
    ```

  - Ограничить количество результатов (например, по 10 для каждой категории)

### 14. Обновление навигации

- **Файл:** `app/page.tsx`
- Редирект на `/vivid/posts` вместо `/posts/new`

### 15. Обновление API для связи постов и тегов

- **Файл:** `app/api/posts/route.ts`
- В POST/PUT endpoints добавить поддержку массива `tagIds`
- Создавать/обновлять связи через PostTag:
- При создании/обновлении поста принимать массив `tagIds` в теле запроса
- Удалять старые связи PostTag для поста
- Создавать новые связи PostTag для каждого tagId из массива
- Обрабатывать ошибки валидации (несуществующие tagIds) и возвращать понятные сообщения для toast
- **Генерация plaintext:**
  - При сохранении поста генерировать `plaintext` из `lexical` контента
  - Использовать функцию для извлечения текста из Lexical JSON структуры
  - Сохранять plaintext в базу данных для использования в поиске

## Порядок выполнения

1. Обновить схему Prisma:

   - Переименовать схему с `memoria_react` на `vivid_react`
   - Добавить поле `color` в модель `Tag`
   - Выполнить миграцию базы данных

2. Добавить UI компоненты (sidebar, table, dialog, toast, popover, command, badge)
3. Создать AdminLayout компонент
4. Создать компонент глобального поиска (GlobalSearch)
5. Создать API endpoint для глобального поиска
6. Интегрировать поиск в AdminLayout с горячей клавишей Cmd/Ctrl+K
7. Создать API endpoints для тегов
8. Создать страницу списка тегов
9. Создать страницу редактирования тега
10. Обновить страницу списка постов с фильтрами
11. Обновить API постов для поддержки фильтрации
12. Создать публичную страницу тега
13. Переместить редактор постов в vivid секцию

## Технические детали

- Использовать Next.js App Router
- Все admin страницы в `/vivid/*`
- Публичные страницы в `/tag/*`
- Схема базы данных: `vivid_react` (переименована с `memoria_react`)
- **Структура ID:**
  - `id` (varchar 24): короткий первичный ключ (cuid), используется в URL и внутренних ссылках
  - `uuid` (varchar 36): стандартный UUID v4, используется для интеграций, проиндексирован
- **Хранение контента:**
  - `lexical`: основной формат редактора (JSON строка)
  - `plaintext`: извлекается из lexical при сохранении, используется для поиска
  - `html`: генерируется из lexical для рендеринга
- Использовать shadcn/ui компоненты для консистентности
- Иконки из lucide-react
- Цвета тегов хранить в формате hex (#RRGGBB)
- Все уведомления об ошибках и успешных операциях отображать через toast компонент
- Не использовать `alert()`, `confirm()` или другие нативные браузерные диалоги
- Toast уведомления должны быть информативными с понятными сообщениями
- Глобальный поиск:
  - Использовать Dialog из shadcn/ui с кастомным backdrop
  - Backdrop: `bg-black/60` или `bg-black/50` для затемнения (opacity 0.5-0.6)
  - z-index: высокий (например, 50 для backdrop, 100 для контента)
  - Горячая клавиша: Cmd+K (Mac) или Ctrl+K (Windows/Linux)
  - Обработка через `useEffect` с `keydown` event listener
  - Предотвращение стандартного поведения браузера для Cmd/Ctrl+K